name: Update Hosts

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  combine_hosts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl grep sed dnsutils

      - name: Download raw host files
        run: |  
          FILES=(
            "https://raw.githubusercontent.com/jerryn70/GoodbyeAds/master/Hosts/GoodbyeAds.txt"
            "https://raw.githubusercontent.com/jerryn70/GoodbyeAds/master/Extension/GoodbyeAds-YouTube-AdBlock.txt" 
            "https://raw.githubusercontent.com/dotywrt/youtube-ads-4-adaway/refs/heads/main/hosts"
            "https://raw.githubusercontent.com/dotywrt/block-torrent/refs/heads/main/Thosts"
          )

          > host1.txt
          for url in "${FILES[@]}"; do
            echo "Downloading $url"
            curl -s "$url" >> host1.txt || echo "⚠️ Failed $url"
          done

      # MODE A → BERSIHKAN hanya domain valid
      - name: Extract domains (Host2)
        run: |
          # Keep only domain-like strings
          grep -oE '([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}' host1.txt \
            | sort -u > host2.txt

      # MODE B → KEEP SEMUA TERMASUK 404
      # Uncomment bawah ni kalau nak kekalkan semua line
      # - name: Extract domains (Host2)
      #   run: |
      #     cat host1.txt | sort -u > host2.txt

      - name: Generate NetGuard hosts file
        run: |
          awk '{print "0.0.0.0 "$0}' host2.txt > netguard-host.txt

      - name: Split large files (>100MB)
        run: |
          split_if_needed() {
            file=$1
            if [ -f "$file" ]; then
              size=$(du -m "$file" | cut -f1)
              if [ "$size" -gt 100 ]; then
                echo "Splitting $file (size ${size}MB)..."
                split -b 95M "$file" "${file}."
                rm "$file"
              fi
            fi
          }
          split_if_needed host1.txt
          split_if_needed host2.txt
          split_if_needed netguard-host.txt

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add netguard-host*
          git commit -m "Update host files" || echo "No changes to commit"
          git push
