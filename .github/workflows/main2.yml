name: Update Hosts

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  combine_hosts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl grep sed dnsutils

      - name: Download raw host files
        run: |
          FILES=(
            "https://raw.githubusercontent.com/REIJI007/Adblock-Rule-Collection/main/ADBLOCK_RULE_COLLECTION_DOMAIN.txt"
            "https://raw.githubusercontent.com/REIJI007/Adblock-Rule-Collection/main/ADBLOCK_RULE_COLLECTION_HOST.txt"
            "https://raw.githubusercontent.com/REIJI007/Adblock-Rule-Collection/main/ADBLOCK_RULE_COLLECTION_HOST_IPV6.txt"
            "https://raw.githubusercontent.com/dotywrt/block-torrent/refs/heads/main/Thosts"
          )

          > host1.txt
          for url in "${FILES[@]}"; do
            echo "Downloading $url"
            curl -s "$url" >> host1.txt || echo "⚠️ Failed $url"
          done

      - name: Extract domains (Host2)
        run: |
          # Remove comments and IPs, keep only domain-like entries
          grep -oE '([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}' host1.txt \
            | sort -u > host2.txt

      - name: Validate domains
        run: |
          echo "Checking DNS resolution..."
          > valid_hosts.txt
          while read -r domain; do
            if host "$domain" > /dev/null 2>&1; then
              echo "$domain" >> valid_hosts.txt
            else
              echo "Dead: $domain"
            fi
          done < host2.txt

          mv valid_hosts.txt host2.txt

      - name: Generate NetGuard hosts file
        run: |
          awk '{print "0.0.0.0 "$0}' host2.txt > netguard-host.txt

      - name: Split large files (>100MB)
        run: |
          split_if_needed() {
            file=$1
            if [ -f "$file" ]; then
              size=$(du -m "$file" | cut -f1)
              if [ "$size" -gt 100 ]; then
                echo "Splitting $file (size ${size}MB)..."
                split -b 95M "$file" "${file}."
                rm "$file"
              fi
            fi
          }
          split_if_needed host1.txt
          split_if_needed host2.txt
          split_if_needed netguard-host.txt

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add host1* host2* netguard-host*
          git commit -m "Update host files" || echo "No changes to commit"
          git push
