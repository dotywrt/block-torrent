name: Update Hosts

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  combine_hosts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl

      - name: Download raw host files
        run: |
          FILES=(
            "https://raw.githubusercontent.com/jerryn70/GoodbyeAds/master/Hosts/GoodbyeAds.txt"
            "https://raw.githubusercontent.com/jerryn70/GoodbyeAds/master/Extension/GoodbyeAds-YouTube-AdBlock.txt"
            "https://raw.githubusercontent.com/dotywrt/youtube-ads-4-adaway/refs/heads/main/hosts"
            "https://raw.githubusercontent.com/dotywrt/block-torrent/refs/heads/main/Thosts"
          )

          > host1.txt
          for url in "${FILES[@]}"; do
            echo "ðŸ”Ž Checking $url ..."
            if curl -s --head --fail "$url" > /dev/null; then
              echo "âœ… Alive: $url"
              curl -s "$url" >> host1.txt
              echo "" >> host1.txt
            else
              echo "âš ï¸ Dead: $url (skipped)"
            fi
          done

      - name: Normalize hosts file
        run: |
          awk '
          # skip kosong & komen
          /^[[:space:]]*$/ { next }
          /^#/ { next }

          # case 1: kekalkan 127.0.0.1 dan ::1
          /^(127\.0\.0\.1|::1)[[:space:]]+/ {
            print $0; next
          }

          # case 2: sudah ada 0.0.0.0 domain
          /^0\.0\.0\.0[[:space:]]+([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}$/ {
            print $0; next
          }

          # case 3: hanya domain valid tanpa 0.0.0.0
          /^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}$/ {
            print "0.0.0.0 "$0; next
          }

          # lain-lain buang
          ' host1.txt | sort -u > host2.txt

      - name: Generate NetGuard hosts file
        run: |
          cp host2.txt netguard-host.txt

      - name: Split large files (>100MB)
        run: |
          split_if_needed() {
            file=$1
            if [ -f "$file" ]; then
              size=$(du -m "$file" | cut -f1)
              if [ "$size" -gt 100 ]; then
                echo "ðŸ“‚ Splitting $file (size ${size}MB)..."
                split -b 95M "$file" "${file}."
                rm "$file"
              fi
            fi
          }
          split_if_needed host1.txt
          split_if_needed host2.txt
          split_if_needed netguard-host.txt

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add netguard-host*
          git commit -m "ðŸ”„ Update host files" || echo "No changes to commit"
          git push
